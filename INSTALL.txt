## Update System
sudo apt-get update

## Install Dependencies
sudo apt-get install python-pip  python-cairo python-django --yes
sudo pip install cffi
sudo pip install -r https://raw.githubusercontent.com/graphite-project/whisper/master/requirements.txt
sudo pip install -r https://raw.githubusercontent.com/graphite-project/carbon/master/requirements.txt
sudo pip install -r https://raw.githubusercontent.com/graphite-project/graphite-web/master/requirements.txt

## Install Whisper, Carbon and Graphite
export PYTHONPATH="/opt/graphite/lib/:/opt/graphite/webapp/"
sudo pip install --no-binary=:all: https://github.com/graphite-project/whisper/tarball/master
sudo pip install --no-binary=:all: https://github.com/graphite-project/carbon/tarball/master
sudo pip install --no-binary=:all: https://github.com/graphite-project/graphite-web/tarball/master

## Setting up Carbon
sudo cp /opt/graphite/conf/carbon.conf.example /opt/graphite/conf/carbon.conf
sudo cp /opt/graphite/conf/storage-schemas.conf.example /opt/graphite/conf/storage-schemas.conf

## Setting up Graphite Web
sudo cp /opt/graphite/webapp/graphite/local_settings.py.example /opt/graphite/webapp/graphite/local_settings.py
sudo nano /opt/graphite/webapp/graphite/local_settings.py # Change SECRET_KEY
sudo PYTHONPATH=/opt/graphite/webapp/ django-admin migrate  --settings=graphite.settings --run-syncdb

# Setting up gunicorn
sudo apt-get install gunicorn --yes
sudo cp /opt/graphite/conf/graphite.wsgi.example /opt/graphite/webapp/wsgi.py

## Setting Graphite Web App Permission
sudo chown -R www-data:www-data /opt/graphite/

# Setting up nginx
sudo apt-get install nginx --yes
cd /etc/nginx/sites-available/
sudo curl -O https://raw.githubusercontent.com/yesoreyeram/graphite-nginx-uwsgi/graphite-nginx-gunicorn/nginx/graphite
sudo ln -s /etc/nginx/sites-available/graphite /etc/nginx/sites-enabled/graphite

# Setup Supervisor
sudo service nginx stop &
sudo apt-get install supervisor --yes
cd /etc/supervisor/conf.d/
sudo curl -O https://raw.githubusercontent.com/yesoreyeram/graphite-nginx-uwsgi/graphite-nginx-gunicorn/supervisor/supervisord.conf
sudo service supervisor restart

# Setup Daemons
#sudo python /opt/graphite/bin/carbon-cache.py --debug start &
#cd /opt/graphite/webapp/
#sudo gunicorn -b 127.0.0.1:5000 wsgi:application &
#sudo service nginx reload

# Validating the installation
echo "foo.bar 1 `date +%s`" | nc localhost 2003
ls /opt/graphite/storage/whisper/
curl "localhost:8888"
curl "localhost:8888/render/?format=json&target=foo.bar&from=-10minutes"
